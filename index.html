<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>APSE Sound Map â€“ Interactive Soundscape Explorer</title>
<!-- 
  VERSIONE GITHUB PAGES
  Percorsi audio: sounds/lamadeipeligni/biophony/, sounds/larissa/, sounds/almazora/
  Testare cliccando marker dopo deploy
-->
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Poppins', system-ui, sans-serif;
    background: #0b0f19;
    color: #f8fafc;
    overflow: hidden;
  }

  #map {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 1;
  }

  /* Sidebar */
  #sidebar {
    position: absolute;
    top: 16px; left: 16px; bottom: 16px;
    width: clamp(280px, 25vw, 380px);
    padding: clamp(16px, 3vw, 24px);
    border-radius: 16px;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(24px);
    border: 1px solid rgba(148,163,184,0.4);
    box-shadow: 0 20px 50px rgba(0,0,0,0.6),
                0 0 30px rgba(34, 197, 94, 0.15);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    transition: left 0.3s ease, opacity 0.3s ease;
    scrollbar-width: thin;
    scrollbar-color: rgba(34, 197, 94, 0.3) transparent;
  }

  #sidebar::-webkit-scrollbar {
    width: 6px;
  }

  #sidebar::-webkit-scrollbar-track {
    background: transparent;
  }

  #sidebar::-webkit-scrollbar-thumb {
    background: rgba(34, 197, 94, 0.3);
    border-radius: 3px;
  }

  #sidebar::-webkit-scrollbar-thumb:hover {
    background: rgba(34, 197, 94, 0.5);
  }

  #sidebar.hidden {
    left: -100vw;
    opacity: 0;
    pointer-events: none;
  }

  #sidebar-close {
    position: absolute;
    top: clamp(12px, 2vw, 16px);
    right: clamp(12px, 2vw, 16px);
    width: clamp(28px, 6vw, 36px);
    height: clamp(28px, 6vw, 36px);
    border-radius: 50%;
    background: rgba(30,41,59,0.8);
    border: 1px solid rgba(148,163,184,0.5);
    color: #f97316;
    font-size: clamp(16px, 4vw, 22px);
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s;
  }

  #sidebar-close:hover {
    background: rgba(249, 115, 22, 0.2);
    border-color: #f97316;
    transform: rotate(90deg);
  }

  #sidebar h2 {
    margin: 0 0 clamp(6px, 1.5vw, 10px);
    font-size: clamp(16px, 3.5vw, 24px);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    background: linear-gradient(135deg, #22c55e 0%, #3b82f6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  #sidebar p {
    margin: 0 0 clamp(12px, 2vw, 16px);
    font-size: clamp(11px, 2vw, 14px);
    color: #94a3b8;
  }

  #sidebar h3 {
    margin: clamp(16px, 2.5vw, 20px) 0 clamp(8px, 1.5vw, 10px);
    font-size: clamp(11px, 2vw, 13px);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #cbd5e1;
  }

  .instructions {
    font-size: clamp(10px, 1.8vw, 12px);
    line-height: 1.6;
    color: #94a3b8;
    margin-bottom: clamp(12px, 2vw, 16px);
  }

  .category-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: clamp(6px, 1.5vw, 10px) clamp(10px, 2vw, 14px);
    margin-bottom: clamp(6px, 1.2vw, 8px);
    border-radius: 10px;
    background: rgba(15,23,42,0.9);
    border: 1px solid rgba(55,65,81,0.8);
    transition: all 0.2s;
  }

  .category-row:hover {
    border-color: rgba(148,163,184,0.6);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .category-label {
    display: flex;
    align-items: center;
    gap: clamp(8px, 1.5vw, 10px);
    font-size: clamp(11px, 2vw, 13px);
    font-weight: 500;
  }

  .dot {
    width: clamp(10px, 2vw, 14px);
    height: clamp(10px, 2vw, 14px);
    border-radius: 50%;
    box-shadow: 0 0 8px currentColor;
    flex-shrink: 0;
  }
  .bio { background: #22c55e; color: #22c55e; }
  .geo { background: #3b82f6; color: #3b82f6; }
  .anthro { background: #f97316; color: #f97316; }

  .toggle {
    width: clamp(36px, 7vw, 44px);
    height: clamp(18px, 3.5vw, 22px);
    border-radius: 999px;
    background: rgba(31,41,55,0.9);
    border: 1px solid rgba(75,85,99,0.9);
    position: relative;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .toggle .knob {
    width: clamp(12px, 2.5vw, 16px);
    height: clamp(12px, 2.5vw, 16px);
    background: #64748b;
    border-radius: 50%;
    position: absolute;
    top: 3px;
    left: 3px;
    transition: all 0.2s;
  }
  .toggle.active {
    background: rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.5);
  }
  .toggle.active .knob {
    left: calc(100% - 3px);
    transform: translateX(-100%);
    background: #22c55e;
    box-shadow: 0 0 10px #22c55e;
  }

  /* Add Marker Button */
  .add-marker-btn {
    margin-top: clamp(16px, 2.5vw, 24px);
    padding: clamp(10px, 2vw, 14px);
    border-radius: 12px;
    background: linear-gradient(135deg, #145C3A 0%, #0A2F24 100%);
    border: 1px solid rgba(34, 197, 94, 0.3);
    color: #fff;
    font-size: clamp(11px, 2vw, 14px);
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
    width: 100%;
  }

  .add-marker-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 30px rgba(34, 197, 94, 0.4);
  }

  .add-marker-btn:active {
    transform: translateY(0);
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: clamp(16px, 3vw, 24px);
    overflow-y: auto;
  }

  .modal.show { display: flex; }

  .modal-content {
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    padding: clamp(20px, 4vw, 28px);
    border-radius: 16px;
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(24px);
    border: 1px solid rgba(148,163,184,0.4);
    box-shadow: 0 20px 60px rgba(0,0,0,0.7);
  }

  .modal-content::-webkit-scrollbar {
    width: 6px;
  }

  .modal-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .modal-content::-webkit-scrollbar-thumb {
    background: rgba(34, 197, 94, 0.3);
    border-radius: 3px;
  }

  .modal h3 {
    margin: 0 0 clamp(12px, 2.5vw, 16px);
    font-size: clamp(16px, 3.5vw, 22px);
    color: #22c55e;
  }

  .modal label {
    display: block;
    margin-top: clamp(10px, 2vw, 14px);
    font-size: clamp(10px, 1.8vw, 12px);
    font-weight: 600;
    color: #cbd5e1;
  }

  .modal input, .modal select {
    width: 100%;
    margin-top: clamp(4px, 1vw, 8px);
    padding: clamp(8px, 2vw, 12px);
    border-radius: 8px;
    background: rgba(30,41,59,0.8);
    border: 1px solid rgba(75,85,99,0.8);
    color: #f8fafc;
    font-size: clamp(12px, 2vw, 14px);
    transition: border-color 0.2s;
  }

  .modal input:focus, .modal select:focus {
    outline: none;
    border-color: rgba(34, 197, 94, 0.6);
  }

  .modal-buttons {
    display: flex;
    gap: clamp(10px, 2vw, 14px);
    margin-top: clamp(16px, 3vw, 24px);
    flex-wrap: wrap;
  }

  .modal-btn {
    flex: 1;
    min-width: 100px;
    padding: clamp(10px, 2vw, 12px);
    border-radius: 8px;
    border: none;
    font-size: clamp(12px, 1.8vw, 14px);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-submit {
    background: linear-gradient(135deg, #145C3A 0%, #0A2F24 100%);
    color: #fff;
  }

  .btn-submit:hover {
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
  }

  .btn-submit:active {
    transform: scale(0.98);
  }

  .btn-cancel {
    background: rgba(51,65,85,0.8);
    color: #cbd5e1;
  }

  .btn-cancel:hover {
    background: rgba(71,85,105,0.8);
  }

  .instructions-text {
    margin-top: clamp(12px, 2vw, 16px);
    padding: clamp(10px, 2vw, 14px);
    border-radius: 8px;
    background: rgba(30,41,59,0.6);
    border-left: 3px solid #22c55e;
    font-size: clamp(10px, 1.6vw, 12px);
    line-height: 1.6;
    color: #94a3b8;
  }

  /* Zoom bar */
  #zoom-bar {
    position: absolute;
    top: clamp(12px, 2.5vw, 20px);
    right: clamp(12px, 2.5vw, 20px);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: clamp(6px, 1.2vw, 10px);
  }

  .zoom-btn {
    width: clamp(36px, 7vw, 48px);
    height: clamp(36px, 7vw, 48px);
    border-radius: 50%;
    border: 1px solid rgba(148,163,184,0.5);
    background: rgba(15,23,42,0.8);
    backdrop-filter: blur(12px);
    color: #f8fafc;
    font-size: clamp(18px, 4vw, 24px);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  }

  .zoom-btn:hover {
    background: rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.6);
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
  }

  .zoom-btn:active {
    transform: scale(0.95);
  }

  /* Popup */
  .leaflet-popup-content-wrapper {
    background: rgba(15,23,42,0.98);
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.5);
    color: #f8fafc;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    padding: clamp(10px, 2vw, 14px) !important;
  }

  .leaflet-popup-tip {
    background: rgba(15,23,42,0.98);
  }

  /* Marker glow per visibilitÃ  */
  .leaflet-interactive {
    filter: drop-shadow(0 0 6px currentColor);
  }

  .popup-title {
    font-size: clamp(12px, 2.5vw, 15px);
    font-weight: 600;
    margin-bottom: clamp(2px, 0.5vw, 4px);
    color: #22c55e;
    word-break: break-word;
  }

  .popup-meta {
    font-size: clamp(10px, 1.8vw, 12px);
    color: #94a3b8;
    margin-bottom: clamp(6px, 1.5vw, 8px);
  }

  audio {
    width: 100%;
    margin-top: clamp(6px, 1.5vw, 10px);
    border-radius: 6px;
    max-width: 280px;
  }

  /* TABLET: 769px - 1024px */
  @media (max-width: 1024px) {
    #sidebar {
      width: clamp(260px, 22vw, 340px);
    }
  }

  /* LANDSCAPE TABLET / SMALL DESKTOP: 768px - 1024px */
  @media (max-width: 768px) {
    #sidebar {
      width: calc(100vw - 32px);
      left: -100vw;
      right: 16px;
    }

    #sidebar.open {
      left: 16px;
    }

    #sidebar.hidden {
      left: -100vw;
    }
  }

  /* MOBILE: below 768px */
  @media (max-width: 600px) {
    #elearn {
      height: auto;
      min-height: 100vh;
    }

    #sidebar {
      width: calc(100vw - 32px);
      bottom: auto;
      top: 70px;
      max-height: calc(100vh - 90px);
    }

    #sidebar.open {
      left: 16px;
    }

    html, body {
      height: auto;
      overflow: auto;
    }
  }

  /* SMALL MOBILE: below 480px */
  @media (max-width: 480px) {
    #sidebar {
      width: calc(100vw - 24px);
      padding: clamp(14px, 3vw, 18px);
      left: -100vw;
    }

    #sidebar.open {
      left: 12px;
    }

    .modal-content {
      margin: auto;
    }

    audio {
      max-width: 100%;
    }
  }

  /* EXTRA SMALL: below 360px */
  @media (max-width: 360px) {
    #sidebar h2 {
      font-size: 14px;
    }

    #sidebar p {
      font-size: 11px;
    }

    .category-label {
      font-size: 11px;
    }

    .modal-btn {
      min-width: 80px;
    }
  }

  #menu-toggle {
    display: flex;
    position: fixed;
    top: clamp(14px, 2.5vw, 22px);
    left: clamp(14px, 2.5vw, 22px);
    width: clamp(44px, 10vw, 56px);
    height: clamp(44px, 10vw, 56px);
    border-radius: 50%;
    background: linear-gradient(135deg, #145C3A 0%, #0A2F24 100%);
    backdrop-filter: blur(12px);
    border: 2px solid rgba(34, 197, 94, 0.6);
    color: #fff;
    font-size: clamp(22px, 5vw, 30px);
    font-weight: bold;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1002;
    box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
    transition: all 0.3s;
    opacity: 0;
    pointer-events: none;
  }

  #menu-toggle.show {
    opacity: 1;
    pointer-events: all;
  }

  #menu-toggle:active {
    transform: scale(0.95);
  }

  /* Overlay scuro quando sidebar aperta */
  #sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 998;
    opacity: 0;
    transition: opacity 0.3s;
  }

  #sidebar-overlay.show {
    display: block;
    opacity: 1;
  }
</style>
</head>

<body>

<div id="sidebar-overlay"></div>

<div id="menu-toggle">â˜°</div>

<div id="sidebar">
  <div id="sidebar-close">Ã—</div>
  
  <h2>APSE Sound Map</h2>
  <p>Interactive Soundscape Explorer</p>

  <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center;">
    <div style="font-family: 'Poppins', sans-serif; font-size: 36px; font-weight: 800; color: #22c55e; line-height: 1; margin-bottom: 4px;" id="total-count">â€“</div>
    <div style="font-size: 11px; color: #94a3b8; letter-spacing: 1.5px; text-transform: uppercase;">Sound Recordings</div>
    <div style="font-size: 10px; color: #64748b; margin-top: 4px;">Across 3 European Countries</div>
  </div>

  <div class="instructions">
    â€¢ Click markers to listen<br>
    â€¢ Use filters to show/hide categories<br>
    â€¢ Add your own recordings from Archive.org
  </div>

  <h3>Legend</h3>

  <div class="category-row">
    <div class="category-label"><div class="dot bio"></div>Biophony</div>
    <div class="toggle active" data-cat="biophony"><div class="knob"></div></div>
  </div>

  <div class="category-row">
    <div class="category-label"><div class="dot geo"></div>Geophony</div>
    <div class="toggle active" data-cat="geophony"><div class="knob"></div></div>
  </div>

  <div class="category-row">
    <div class="category-label"><div class="dot anthro"></div>Anthropophony</div>
    <div class="toggle active" data-cat="anthropophony"><div class="knob"></div></div>
  </div>

  <div class="add-marker-btn" id="add-marker">
    + Add Audio Marker
  </div>
</div>

<div id="zoom-bar">
  <div class="zoom-btn" id="zoom-in">+</div>
  <div class="zoom-btn" id="zoom-out">âˆ’</div>
</div>

<div id="map"></div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Add Audio Marker</h3>

    <label>Location Name</label>
    <input type="text" id="input-name" placeholder="e.g., Forest Creek" />

    <label>Latitude</label>
    <input type="number" step="0.000001" id="input-lat" placeholder="e.g., 42.083" />

    <label>Longitude</label>
    <input type="number" step="0.000001" id="input-lng" placeholder="e.g., 14.183" />

    <label>Archive.org Audio URL</label>
    <input type="text" id="input-url" placeholder="https://archive.org/download/..." />

    <label>Sound Category</label>
    <select id="input-cat">
      <option value="biophony">Biophony</option>
      <option value="geophony">Geophony</option>
      <option value="anthropophony">Anthropophony</option>
    </select>

    <div class="instructions-text">
      <strong>How to get Archive.org URL:</strong><br>
      1. Upload your audio to <a href="https://archive.org/upload/" target="_blank" style="color: #22c55e;">archive.org/upload/</a><br>
      2. After upload, click on your file<br>
      3. Right-click the "VBR MP3" download link â†’ Copy link address<br>
      4. Paste the URL here (should end with .mp3)
    </div>

    <div class="modal-buttons">
      <button class="modal-btn btn-cancel" id="btn-cancel">Cancel</button>
      <button class="modal-btn btn-submit" id="btn-submit">Add Marker</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* MAP SETUP */
const map = L.map('map', {
  zoomControl: false,
  center: [40.0, 15.0],
  zoom: 5
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

/* CUSTOM ZOOM */
document.getElementById("zoom-in").onclick = () => map.zoomIn();
document.getElementById("zoom-out").onclick = () => map.zoomOut();

/* BASE URL */
const BASE = "https://raw.githubusercontent.com/ApseProjectEU/soundmap/main/sounds/";

/* AUDIO DATA - STRUTTURA CORRETTA */
const soundData = {
  lamadeipeligni: {
    base: [42.083, 14.183],
    path: "lamadeipeligni/biophony/",
    sounds: {
      biophony: [
        "barn-swallow.mp3",
        "buzzards-crows-pine-forest.mp3",
        "common-buzzard.mp3",
        "common-chaffinch.mp3",
        "common-kestrel.mp3",
        "common-raven.mp3",
        "common-redstart.mp3",
        "dalmatian-woodpecker.mp3",
        "eurasian-blackcap.mp3",
        "eurasian-treecreeper.mp3",
        "european-robin.mp3",
        "goldcrest.mp3",
        "golden-eagle.mp3",
        "great-tit.mp3",
        "house-martin.mp3",
        "peregrine-falcon.mp3",
        "red-deer-roaring.mp3"
      ],
      geophony: [
        "hifi-soundscape-lama.mp3",
        "river-forest-binaural.mp3",
        "Campo aperto Fiume aventino.mp3",
        "Vento a Fonte tarÃ¬.mp3"
      ],
      anthropophony: [
        "Motosega ed albero che cade.mp3",
        "Mercato Locale Lama dei Peligni.mp3",
        "Piazza di Lama campana.mp3"
      ]
    }
  },

  larissa: {
    base: [39.639, 22.419],
    path: "larissa/biophony/",  // CORRETTO: tutti i file in /biophony/
    sounds: {
      biophony: [
        "11_canary-doorbell-72375.mp3",
        "13_nightingale-birds-spring-339975.mp3",
        "15_croaking-frogs.mp3",
        "1_bees-54954.mp3",
        "3_cicada-126650.mp3",
        "cicadas.mp3",
        "chamois-inner.mp3",
        "chamois-lower.mp3",
        "chamois-observation.mp3",
        "Pigeon.mp3",
        "rooster.mp3",
        "papanerosounds.mp3"
      ],
      geophony: [
        "river-soundscape.mp3",
        "sea_waves.mp3",
        "waterfall.mp3",
        "montgo.mp3",
        "forest-demo.mp3",
        "forest-edge.mp3",
        "forest-exit-east.mp3",
        "forest-lower-clearing.mp3",
        "forest-threshold.mp3",
        "forest-west.mp3",
        "pine-forest-inner.mp3",
        "pine-forest-ridge.mp3",
        "pine-forest-south.mp3",
        "pine-forest-upper.mp3",
        "nepalearthquakesound.mp3",
        "smallfountain.mp3",
        "valley-edge.mp3",
        "valley-lower.mp3"
      ],
      anthropophony: [
        "access-east.mp3",
        "boat1.mp3",
        "convent-courtyard.mp3",
        "convent-lower.mp3",
        "convent-viewpoint.mp3",
        "panigiri.mp3",
        "parks.mp3",
        "road.mp3",
        "urbancicades.mp3"
      ]
    }
  },

  almazora: {
    base: [39.938, -0.065],
    path: "almazora/",
    sounds: {
      biophony: [
        "2 Murmuration - Irish Wildlife Sounds.mp3",
        "AUDIO-2025-03-16-18-44-45.mp3",
        "AUDIO-2025-03-17-13-00-09.mp3",
        "BandCampDownloader.app - soundscape - CRICKETS IN THE NORTH OF GREECE - Clovis Tisserand.mp3"
      ],
      geophony: [
        "almazora 12_wind 82kmh-desert.mp3",
        "2 Soundscape Wind Through The Cane - Clovis Tisserand.mp3",
        "3 Soundscape Wind Through The Wheat - Clovis Tisserand.mp3"
      ],
      anthropophony: [
        "Almazora antropo .mp3",
        "Valencia Ruzafa (Russafa) Real City Sounds 4K Walk - No Music.mp3",
        "almazora antropo2.mp3",
        "almazora antropofonia1.mp3",
        "antropofo 3 almazora.mp3"
      ]
    }
  }
};

/* LAYER GROUPS */
const groups = {
  biophony: L.layerGroup().addTo(map),
  geophony: L.layerGroup().addTo(map),
  anthropophony: L.layerGroup().addTo(map)
};

/* COLORI CATEGORIE */
const colors = {
  biophony: "#22c55e",
  geophony: "#3b82f6",
  anthropophony: "#f97316"
};

/* AGGIUNGI MARKERS */
function addMarkers() {
  const bounds = [];
  const clusterCounts = {};

  for (const place in soundData) {
    const location = soundData[place];
    const baseLat = location.base[0];
    const baseLng = location.base[1];
    
    // Conta totale suoni per location
    let totalSounds = 0;
    for (const category in location.sounds) {
      totalSounds += location.sounds[category].length;
    }
    clusterCounts[place] = totalSounds;

    for (const category in location.sounds) {
      location.sounds[category].forEach(filename => {
        // Coordinate leggermente randomizzate
        const lat = baseLat + (Math.random() - 0.5) * 0.015;
        const lng = baseLng + (Math.random() - 0.5) * 0.015;

        // URL encoding per spazi
        const encodedFilename = encodeURIComponent(filename);
        const audioUrl = BASE + location.path + encodedFilename;

        // Crea marker circolare - PIÃ™ GRANDE per visibilitÃ 
        const markerRadius = window.innerWidth <= 768 ? 12 : 10; // PiÃ¹ grande su mobile
        const marker = L.circleMarker([lat, lng], {
          radius: markerRadius,
          color: colors[category],
          fillColor: colors[category],
          fillOpacity: 0.85,
          weight: 2,
          opacity: 1
        });

        // Popup
        const popup = `
          <div class="popup-title">${filename}</div>
          <div class="popup-meta">${place} â€¢ ${category}</div>
          <audio controls preload="none">
            <source src="${audioUrl}" type="audio/mpeg">
            Your browser does not support audio playback.
          </audio>
        `;

        marker.bindPopup(popup);
        marker.addTo(groups[category]);
        bounds.push([lat, lng]);
      });
    }
  }

  // Fit map to show all markers - PANORAMIC VIEW per mostrare tutti i cluster
  if (bounds.length) {
    map.fitBounds(bounds, { 
      padding: [80, 80],
      maxZoom: 6  // Limita zoom per vista panoramica Europa
    });
  }

  // Anima contatore totale marker
  const totalEl = document.getElementById('total-count');
  if (totalEl) {
    let count = 0;
    const target = bounds.length;
    const duration = 1500;
    const increment = target / (duration / 16);
    
    const counter = setInterval(() => {
      count += increment;
      if (count >= target) {
        totalEl.textContent = target;
        clearInterval(counter);
      } else {
        totalEl.textContent = Math.floor(count);
      }
    }, 16);
  }

  // BADGE CLUSTER - mostrano numero totale per localitÃ 
  const clusterBadges = {
    lamadeipeligni: { coords: [42.083, 14.183], name: 'Lama dei Peligni', count: clusterCounts.lamadeipeligni },
    larissa: { coords: [39.639, 22.419], name: 'Larissa', count: clusterCounts.larissa },
    almazora: { coords: [39.938, -0.065], name: 'Almazora', count: clusterCounts.almazora }
  };

  for (const key in clusterBadges) {
    const cluster = clusterBadges[key];
    const clusterIcon = L.divIcon({
      className: 'cluster-badge',
      html: `
        <div style="
          background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(45, 158, 96, 0.95));
          border: 2px solid rgba(255, 255, 255, 0.9);
          border-radius: 50%;
          width: 56px;
          height: 56px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-direction: column;
          box-shadow: 0 4px 20px rgba(34, 197, 94, 0.5), 0 0 30px rgba(34, 197, 94, 0.3);
          cursor: pointer;
          transition: all 0.3s;
        " onmouseover="this.style.transform='scale(1.15)'" onmouseout="this.style.transform='scale(1)'">
          <div style="font-size: 20px; font-weight: 800; color: #fff; line-height: 1;">${cluster.count}</div>
          <div style="font-size: 7px; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">sounds</div>
        </div>
      `,
      iconSize: [56, 56],
      iconAnchor: [28, 28]
    });

    const clusterMarker = L.marker(cluster.coords, { icon: clusterIcon });
    
    // CLICK per zoom automatico sulla localitÃ 
    clusterMarker.on('click', function() {
      map.flyTo(cluster.coords, 13, {
        duration: 1.5,
        easeLinearity: 0.25
      });
    });

    clusterMarker.bindPopup(`
      <div style="text-align: center; padding: 8px;">
        <div style="font-size: 16px; font-weight: 700; color: #22c55e; margin-bottom: 4px;">${cluster.name}</div>
        <div style="font-size: 13px; color: #94a3b8;">${cluster.count} soundscape recordings</div>
        <div style="font-size: 11px; color: #64748b; margin-top: 6px;">ðŸ‘† Click to zoom in</div>
      </div>
    `);

    // Mostra badge solo a zoom basso, nascondi a zoom alto
    map.on('zoomend', function() {
      const zoom = map.getZoom();
      if (zoom <= 7) {
        if (!map.hasLayer(clusterMarker)) map.addLayer(clusterMarker);
      } else {
        if (map.hasLayer(clusterMarker)) map.removeLayer(clusterMarker);
      }
    });

    // Aggiungi subito se zoom iniziale Ã¨ basso
    if (map.getZoom() <= 7) {
      clusterMarker.addTo(map);
    }
  }
}

addMarkers();

/* FILTERS */
document.querySelectorAll(".toggle").forEach(toggle => {
  toggle.onclick = () => {
    toggle.classList.toggle("active");
    const cat = toggle.dataset.cat;
    if (toggle.classList.contains("active")) {
      groups[cat].addTo(map);
    } else {
      map.removeLayer(groups[cat]);
    }
  };
});

/* MODAL CONTROLS */
const modal = document.getElementById("modal");
const addBtn = document.getElementById("add-marker");
const cancelBtn = document.getElementById("btn-cancel");
const submitBtn = document.getElementById("btn-submit");

addBtn.onclick = () => {
  modal.classList.add("show");
};
cancelBtn.onclick = () => modal.classList.remove("show");

submitBtn.onclick = () => {
  const name = document.getElementById("input-name").value.trim();
  const lat = parseFloat(document.getElementById("input-lat").value);
  const lng = parseFloat(document.getElementById("input-lng").value);
  const url = document.getElementById("input-url").value.trim();
  const cat = document.getElementById("input-cat").value;

  if (!name || isNaN(lat) || isNaN(lng) || !url) {
    alert("Please fill all fields correctly");
    return;
  }

  // Valida URL Archive.org
  if (!url.includes("archive.org")) {
    alert("Please use a valid Archive.org URL");
    return;
  }

  // Crea nuovo marker
  const marker = L.circleMarker([lat, lng], {
    radius: 9,
    color: colors[cat],
    fillColor: colors[cat],
    fillOpacity: 0.85,
    weight: 2,
    opacity: 1
  });

  const popup = `
    <div class="popup-title">${name}</div>
    <div class="popup-meta">User contribution â€¢ ${cat}</div>
    <audio controls preload="none">
      <source src="${url}" type="audio/mpeg">
      Your browser does not support audio playback.
    </audio>
  `;

  marker.bindPopup(popup);
  marker.addTo(groups[cat]);
  
  // Chiudi modal e resetta form
  modal.classList.remove("show");
  document.getElementById("input-name").value = "";
  document.getElementById("input-lat").value = "";
  document.getElementById("input-lng").value = "";
  document.getElementById("input-url").value = "";
  
  alert("Marker added successfully!");
};

// Chiudi modal cliccando fuori
modal.onclick = (e) => {
  if (e.target === modal) {
    modal.classList.remove("show");
  }
};

/* SIDEBAR TOGGLE - funziona DESKTOP + MOBILE */
const menuToggle = document.getElementById("menu-toggle");
const sidebar = document.getElementById("sidebar");
const sidebarClose = document.getElementById("sidebar-close");
const overlay = document.getElementById("sidebar-overlay");

// Inizializza stato in base a dimensione schermo
function initSidebar() {
  if (window.innerWidth <= 768) {
    // MOBILE: sidebar chiusa, menu visibile
    sidebar.classList.add('hidden');
    menuToggle.classList.add('show');
  } else {
    // DESKTOP: sidebar aperta, menu nascosto
    sidebar.classList.remove('hidden');
    menuToggle.classList.remove('show');
  }
}

initSidebar();

// Re-inizializza su resize
window.addEventListener('resize', initSidebar);

function openSidebar() {
  sidebar.classList.remove('hidden');
  sidebar.classList.add('open');
  overlay.classList.add('show');
  menuToggle.classList.remove('show');
}

function closeSidebar() {
  sidebar.classList.add('hidden');
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
  
  // Mostra menu solo su mobile
  if (window.innerWidth <= 768) {
    menuToggle.classList.add('show');
  }
}

// Pulsante â˜° apre sidebar
menuToggle.onclick = openSidebar;

// Pulsante X chiude sidebar
sidebarClose.onclick = closeSidebar;

// Overlay chiude sidebar
overlay.onclick = closeSidebar;

// Click su mappa chiude sidebar (solo mobile)
map.on('click', () => {
  if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
    closeSidebar();
  }
});
</script>

</body>
</html>
