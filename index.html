<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>APSE Soundmap</title>
<base href="/soundmap/">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  #map { height: 100vh; width: 100%; }

  .legend {
    background: white;
    padding: 10px;
    line-height: 18px;
    border-radius: 4px;
    font-size: 14px;
  }
  .legend i {
    width: 14px;
    height: 22px;
    float: left;
    margin-right: 8px;
    opacity: 1;
    background-size: contain;
    background-repeat: no-repeat;
  }
</style>
</head>

<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* -------------------------------------------------------
   BASE MAP
------------------------------------------------------- */
const map = L.map('map', {
  zoom: 5,
  center: [42.1, 14.2],
  zoomControl: false,
  doubleClickZoom: false,
  scrollWheelZoom: false,
  touchZoom: false,
  boxZoom: false,
  keyboard: false
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

/* -------------------------------------------------------
   MARKER ICONS (Leaflet-style colored drops)
------------------------------------------------------- */
function coloredIcon(color) {
  return new L.Icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });
}

const icons = {
  biophony: coloredIcon("green"),
  anthropophony: coloredIcon("red"),
  geophony: coloredIcon("blue")
};

/* -------------------------------------------------------
   LOAD LOCATIONS FROM JSON
------------------------------------------------------- */
let allMarkers = [];

fetch('./locations.json')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        console.log('✓ locations.json loaded');
        return response.json();
    })
    .then(locations => {
        console.log(`✓ Loaded ${locations.length} locations`);

        locations.forEach(location => {
            const marker = L.marker([location.lat, location.lng], {
                icon: icons[location.category]
            }).addTo(map);

            const categoryLabel = location.category.charAt(0).toUpperCase() + location.category.slice(1);

            const popupContent = `
                <div class="popup-content">
                    <span class="category-badge ${location.category}">${categoryLabel}</span>
                    <h3>${location.title}</h3>
                    <p>${location.description}</p>
                    <audio controls
                           style="width:200px;"
                           onerror="console.error('❌ Audio failed:', '${location.audioUrl}')">
                        <source src="${location.audioUrl}" type="audio/mpeg">
                        Audio not available
                    </audio>
                </div>
            `;

            marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'custom-popup'
            });

            allMarkers.push({ marker, category: location.category });
        });

        console.log('✓ All markers loaded');
    })
    .catch(error => {
        console.error('❌ ERROR:', error);
        alert('Failed to load map: ' + error.message);
    });

/* -------------------------------------------------------
   LEGENDA
------------------------------------------------------- */
const legend = L.control({ position: "bottomright" });

legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <b>Sound Categories</b><br>
    <i style="background-image:url('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png')"></i> Biophony<br>
    <i style="background-image:url('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png')"></i> Anthropophony<br>
    <i style="background-image:url('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png')"></i> Geophony
  `;
  return div;
};

legend.addTo(map);
</script>

</body>
</html>
